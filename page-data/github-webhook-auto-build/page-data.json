{
    "componentChunkName": "component---src-templates-blog-post-js",
    "path": "/github-webhook-auto-build/",
    "result": {"data":{"site":{"siteMetadata":{"title":"Howdy"}},"markdownRemark":{"id":"3609a093-294a-56cf-bdda-5c7b81591f04","excerpt":"前言 因为博客使用 Gatsbyjs 进行搭建，Markdown文章写完之后会打包成静态HTML文件，文章是存在项目文件中并非数据库中，所以每次进行博客文章更新后，都需要重新进行打包构建。在进行git push后，我需要连到云服务器中，然后进入项目目录，执行git pull / npm run clean / npm…","html":"<h2 id=\"前言\" style=\"position:relative;\"><a href=\"#%E5%89%8D%E8%A8%80\" aria-label=\"前言 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>前言</h2>\n<p>因为博客使用 <strong><a href=\"https://www.gatsbyjs.org/\" target=\"_blank\">Gatsbyjs</a></strong> 进行搭建，Markdown文章写完之后会打包成静态HTML文件，文章是存在项目文件中并非数据库中，所以每次进行博客文章更新后，都需要重新进行打包构建。在进行git push后，我需要连到云服务器中，然后进入项目目录，执行git pull / npm run clean / npm run build 等命令。</p>\n<p>为了简化该操作，通过使用Github的 <strong><a href=\"https://developer.github.com/webhooks/\" target=\"_blank\">Webhooks</a></strong> 服务，在服务端监听git push事件，然后自动执行编写好的脚本从而实现自动化构建部署。以后Git push后就无需再进行后续操作，由脚本完成。</p>\n<p>目前主流的自动化构建部署工具可以选择 <strong><a href=\"https://jenkins.io/zh/\" target=\"_blank\">Jenkins</a></strong>，Jenkins是一个持续集成管理平台，提供超过1000个插件来支持构建、部署、自动化， 满足任何项目的需要。但由于Jenkins是基于<strong>Java</strong>环境，而且功能过于强大，对于个人的项目来说有点大材小用，而且加重个人服务器资源的压力。所以没有采用Jenkins进行自动化构建部署，而是采用自己编写的<strong>Koa2</strong>服务来接收Github Webhook来实现简单自动化构建。</p>\n<h2 id=\"配置webhooks\" style=\"position:relative;\"><a href=\"#%E9%85%8D%E7%BD%AEwebhooks\" aria-label=\"配置webhooks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>配置Webhooks</h2>\n<ol>\n<li>进入自己需要监听Push请求的Github仓库，点击Settings => Webhooks => Add webhook</li>\n</ol>\n<p><img src=\"https://s2.loli.net/2021/12/04/7mvAXfC5hNRlFZM.png\" alt=\"Create Webhook\">\n2. 填写自己服务器请求地址，配置Secret(用于后面的Sha1解码验证)，并选择要监听的事件，本次只监听push\n<img src=\"https://s2.loli.net/2021/12/04/gPluNLOBHdbcwsK.png\" alt=\"Webhook form\">\n3. 进入到对应Webhooks详情，下方可以查看到每个请求记录，点击Redeliver可以重新发送该请求。\n<img src=\"https://s2.loli.net/2021/12/04/KjZe4gN8RDJt7l9.png\" alt=\"Redeliver\"></p>\n<h2 id=\"后端koa2服务\" style=\"position:relative;\"><a href=\"#%E5%90%8E%E7%AB%AFkoa2%E6%9C%8D%E5%8A%A1\" aria-label=\"后端koa2服务 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>后端Koa2服务</h2>\n<p>后端的Koa2服务是本功能的最重要的环节。其处理流程：</p>\n<ol>\n<li>接收Github Webhooks的Post请求</li>\n<li>提取请求头与请求Body信息，并验证是否缺少必要参数</li>\n<li>使用Crypto的 <strong><a href=\"http://nodejs.cn/api/crypto.html#crypto_crypto_createhmac_algorithm_key_options\" target=\"_blank\">HMACSHA1</a></strong> 算法，将服务端设置的密钥对请求Body进行哈希编码，然后判断解码出来的与请求头中的x-hub-signature是否匹配，防止有他人对自己的服务器发送了伪造的非法请求或篡改了Github原请求。</li>\n<li>针对不同Git事件与Git仓库使用Nodejs的 <strong><a href=\"http://nodejs.cn/api/child_process.html\" target=\"_blank\">child_process</a></strong> 执行不同的脚本文件</li>\n</ol>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> Router <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'koa-router'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> Response <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../utils/response'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> crypto <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'crypto'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> exec <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'child_process'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> logger <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../utils/log'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> webhookSecret <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../config/config'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> r <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Response</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> router <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Router</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// router的路由路径在Github配置webhook时配置，webhook为向该路径发送请求</span>\nrouter<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/****'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token parameter\">ctx</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> requestData <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">.</span>body</span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> sig <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'x-hub-signature'</span><span class=\"token punctuation\">]</span></span>  <span class=\"token keyword\">const</span> event <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'x-github-event'</span><span class=\"token punctuation\">]</span>\n  <span class=\"token keyword\">const</span> id <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'x-github-delivery'</span><span class=\"token punctuation\">]</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>sig <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>event <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>id<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    ctx<span class=\"token punctuation\">.</span>body <span class=\"token operator\">=</span> r<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token number\">310</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'No Github hook headers'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token punctuation\">[</span><span class=\"token string\">'ping'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'push'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    ctx<span class=\"token punctuation\">.</span>body <span class=\"token operator\">=</span> r<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token number\">311</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Gihub Hook events not allow'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> repository<span class=\"token punctuation\">,</span> sender <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> requestData\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>repository <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>sender<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    ctx<span class=\"token punctuation\">.</span>body <span class=\"token operator\">=</span> r<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token number\">312</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Missing essential parameters'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> name<span class=\"token operator\">:</span> repositoryName <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> repository\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token function\">logger</span><span class=\"token punctuation\">(</span><span class=\"token string\">'接收到Webhook'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">event:</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>event<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">, respository: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>repositoryName<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span></span>  <span class=\"token keyword\">const</span> clientSig <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">sha1=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>crypto<span class=\"token punctuation\">.</span><span class=\"token function\">createHmac</span><span class=\"token punctuation\">(</span><span class=\"token string\">'sha1'</span><span class=\"token punctuation\">,</span> webhookSecret<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span><span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>requestData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">digest</span><span class=\"token punctuation\">(</span><span class=\"token string\">'hex'</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>sig <span class=\"token operator\">!==</span> clientSig<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">logger</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Webhook X-Hub-Signature解码'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'解码不匹配'</span><span class=\"token punctuation\">)</span>\n    ctx<span class=\"token punctuation\">.</span>body <span class=\"token operator\">=</span> r<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token number\">313</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'X-Hub-Signature does not match'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>event <span class=\"token operator\">===</span> <span class=\"token string\">'ping'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    ctx<span class=\"token punctuation\">.</span>body <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n      errCode<span class=\"token operator\">:</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span>\n      errMsg<span class=\"token operator\">:</span> <span class=\"token string\">'Success'</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>event <span class=\"token operator\">===</span> <span class=\"token string\">'push'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    ctx<span class=\"token punctuation\">.</span>body <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n      errCode<span class=\"token operator\">:</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span>\n      errMsg<span class=\"token operator\">:</span> <span class=\"token string\">'Success'</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>repositoryName <span class=\"token operator\">===</span> <span class=\"token string\">'****'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">updateBlog</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// updateBlog为接收到hook后要执行的操作</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">updateBlog</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">exec</span><span class=\"token punctuation\">(</span><span class=\"token string\">'****.bat'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">logger</span><span class=\"token punctuation\">(</span><span class=\"token string\">'执行****.bat'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">return</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">logger</span><span class=\"token punctuation\">(</span><span class=\"token string\">'执行****.bat'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  githubWebhookRouter<span class=\"token operator\">:</span> router\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>在新建Webhooks后，github会发送一个ping事件到目标服务器，所以这里加多了一种ping事件的处理（直接返回200）。</p>\n<p>本次我设置了只有push事件会发请求，所以只处理了push事件，如果设置Webhooks监听其他事件，例如release、issues、star等，可自行扩展对应功能。</p>\n<h2 id=\"其他说明\" style=\"position:relative;\"><a href=\"#%E5%85%B6%E4%BB%96%E8%AF%B4%E6%98%8E\" aria-label=\"其他说明 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>其他说明</h2>\n<ol>\n<li>后端可直接使用原生Nodejs搭建服务，使用 <strong><a href=\"https://github.com/rvagg/github-webhook-handler#readme\" target=\"_blank\">github-webhook-hanlder</a></strong> 包可快速搭建</li>\n<li>建议设置Secert密钥，防止伪造的请求</li>\n<li>本方式适合简单的前端资源自动化部署构建，对于大型的项目还是建议使用Jenkins等持续集成工具进行自动化部署</li>\n<li>可监听Github Webhooks其他事件，issue、start等，并通过 <strong><a href=\"https://developer.github.com/v3/\" target=\"_blank\">Github API</a></strong> 可实现下Git仓库机器人等功能</li>\n<li>Github Webhooks请求中有很多有用的信息，例如多人项目中你可以记录是由谁push的，或者处理的是哪个分支等，都可以提取出来进行不同的处理。</li>\n<li>脚本可使用Shell编写再由Nodejs的child_process去执行，也可以直接编写nodejs命令直接去执行文件操作。社区也提供很多类似<code class=\"language-text\">shelljs</code>、<code class=\"language-text\">exec-sh</code>等NPM包可以更优雅的编写脚本命令。</li>\n<li>这种方式适合将网站自动部署到自己的个人服务器，如果没有服务器可以采用<code class=\"language-text\">Github Page</code>方式部署，这时候可以利用<code class=\"language-text\">Github Action</code>去实现，具体后面再写一篇文章说明。</li>\n</ol>\n<p><em>以上内容未经授权请勿随意转载。</em></p>","frontmatter":{"title":"Github Webhooks与Koa2实现简单的前端自动化部署","date":"April 12, 2020","description":"Git仓库配置了Github Webhooks后，在进行Push等事件时，Github会向设定的服务器发送请求，通过监听该请求，然后执行相关脚本文件从而实现简单的自动化构建与部署（服务端使用Koa2接收请求与处理脚本）"}}},"pageContext":{"slug":"/github-webhook-auto-build/","previous":{"fields":{"slug":"/design-of-nav-tab/"},"frontmatter":{"title":"浏览器导航首页设计"}},"next":{"fields":{"slug":"/build-component-cabinet/"},"frontmatter":{"title":"个人组件库展示站点搭建总结"}}}},
    "staticQueryHashes": ["143701507","165057280"]}